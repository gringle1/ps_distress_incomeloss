---
title: "Merge American Trends Panel Data for Analysis of Income loss and Psychological Distress"
author: "Grace V Ringlein"
date: "2023-08-16"
---

This file contains code used to merge the raw data from five waves of the Pew Research Center's American Trends Panel, for use in Ringlein GV, Ettman CK, and Stuart EA, 2024 ("Income or Job Loss and Psychological Distress During the COVID-19 Pandemic"). <doi:10.1001/jamanetworkopen.2024.24601>

`make_composite_columns.Rmd` reads in the saved data from this file (`pewMH_dataset_merged.sav`) and creates composite columns, saving a new data set `pewMH_dataset_merged_comp.sav` which is used `analysis.Rmd`

Notes (see manuscript and supplement for more details):

-   Data downloaded from <https://www.pewresearch.org/american-trends-panel-datasets/>

-   Waves 64, 66, 83, 114 have mental health data used to construct psychological distress score.

-   Wave 66 is not used in the final analysis.

-   Wave 64 also has self or household income or job loss.

-   Wave 72 has self or household income or job loss.

-   Wave 54 has pre-pandemic finances.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning=FALSE)
<<<<<<< HEAD
library(haven) 
library(labelled) 
library(dplyr)
library(here)
```

### Read in data for waves with mental health data: W64, W83, W114

```{r read_MH_data}
#READ IN DATA FOR MENTAL HEALTH WAVES
W114 <- read_sav(here("data","ATP W114.sav"))
W64 <- read_sav(here("data","ATP W64.sav"))
W83 <- read_sav(here("data","ATP W83.sav"))
```

### Read in data for waves with pre-pandemic finances and job loss information

```{r read_cov_data}
W54 <- read_sav(here("data","ATP W54.sav"))
W72 <- read_sav(here("data","ATP W72.sav"))
```

### Rename columns to have wave number

Note: We do not rename columns that already have wave number or QKEY, the subject ID column, which is used for merging data sets

```{r rename_cols}
W54 <- W54 %>% rename_at(vars(!matches("*(_W..)"),-QKEY), ~paste0(., '_W54'))
W64 <- W64 %>% rename_at(vars(!matches("*(_W..)"),-QKEY), ~paste0(., '_W64'))
W72 <- W72 %>% rename_at(vars(!matches("*(_W..)"),-QKEY), ~paste0(., '_W72'))
W83 <- W83 %>% rename_at(vars(!matches("*(_W..)"),-QKEY), ~paste0(., '_W83'))
W114 <- W114 %>% rename_at(vars(!matches("*(_W..)"),-QKEY), ~paste0(., '_W114'))
```

### Add responded column to indicate which participants were included in each wave once data is merged

Note: some Waves already include such an indicators for a previous waves. For example, W114 has columns "F_RESPONDED_W64", "F_RESPONDED_W66", "F_RESPONDED_W83", F_RESPONDED_W114"

```{r add_responded_col}
W64$F_RESPONDED_W64 <- c(rep(1,nrow(W64)))
W54$F_RESPONDED_W54 <- c(rep(1,nrow(W54)))
W72$F_RESPONDED_W72 <- c(rep(1,nrow(W72)))
W83$F_RESPONDED_W83 <- c(rep(1,nrow(W83)))
W114$F_RESPONDED_W114 <- c(rep(1,nrow(W114)))
```

### Merge mental health data waves W64, W83, and W114 and remove any columns that are duplicated via merge
Note: Some columns are duplicated because later W114 data set contain the results of earlier waves' mental health questions

```{r merge_MH}
W_MH <- W64 %>%
  full_join(W83,by="QKEY",suffix=c("","_dup_W83")) %>%
  full_join(W114,by="QKEY",suffix=c("","_dup_W114"))

W_MH <- W_MH %>% select(!contains("dup"))
```

### Merge mental health data with W54 (prepandemic finances) and W72 (mid pandemic job/income loss)

```{r, merge_cov}
W_cov <- W54 %>% 
  full_join(W72, by="QKEY",suffix=c("","_dup")) 
W_cov <- W_cov %>% select(!contains("dup"))

W <- left_join(W_MH,W_cov,by="QKEY",suffix=c("_dup",""))
W <- W %>% select(!contains("dup"))
```

### Reorder so QKEY and response indicator columns are first

```{r}
W <- W %>% relocate("QKEY",contains("RESPONDED"))
```

### Select columns of interest
Note: Not all of these columns are used in the final analysis

```{r select_cols}
W_wide <- W %>% select("QKEY",
                  contains("RESPONDED"),
                  contains("WEIGHT"),
                  
                  #DEMOGRAPHICS
                  contains("GENDER"),contains("SEX"),
                  contains("RACE"),contains("HISP"),
                  contains("CREGION"),
                  contains("METRO"),
                  contains("EDUCCAT"),
                  contains("MARITAL"),
                  contains("AGE"),
                  contains("CITIZEN"),
                  contains("PARENT"),
                  
                  #MENTAL HEALTH
                  contains("MH_TRACK"),contains("MENTAL"),
                  
                  #FINANCES
                  contains("INC_TIER2"),
                  contains("FINANCE"),
                  contains("DEBT"),
                  contains("SAVINGS"),
                  contains("WORRY2"),
                  
                  #EMPLOYMENT
                  contains("E3"),contains("E1"),contains("E2"),
                  contains("COVIDWORK")
                  )
```

### Replace 99 (missing data indicator) with NA

```{r replace_NA}
W_wide <- W_wide %>% mutate(across(where(is.numeric),~na_if(.x,99)))
```

### Add weights for 5 waves of data, sent to the team 8/15/2023

```{r}
W_wide <- tryCatch({
  weights <- read_sav(here("data","ATP_W54-64-72-83-114_weights.sav"))
  W_wide %>% left_join(weights,by="QKEY")
 }, error=function(e){
   message(e)
   return(W_wide)
}) 
```

### Save data set
```{r}
write_sav(W_wide, here("data","pewMH_dataset_merged.sav"))
message(paste("Saved combined dataset to"),here("data","pewMH_dataset_merged.sav"))
rm(list=ls())
```
